<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing Utilization Dashboard (Live Data)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .kpi-card {
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-7xl bg-white rounded-2xl shadow-2xl overflow-hidden">
        <header class="bg-gradient-to-r from-cyan-800 to-cyan-900 text-white p-6">
            <h1 class="text-3xl font-extrabold tracking-tight">Housing Utilization Dashboard</h1>
            <p class="text-cyan-200 text-lg mt-1">A Combined Analysis of Room & Headcount Occupancy</p>
        </header>

        <main class="p-6 md:p-8">
            <section id="kpi-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                </section>

            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4 text-center">Room Occupancy by Location</h2>
                    <div class="relative h-[350px]"><canvas id="roomChart"></canvas></div>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4 text-center">Headcount Allocation</h2>
                    <div class="relative h-[350px]"><canvas id="headcountChart"></canvas></div>
                </div>
            </section>

             <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                 <h2 class="text-2xl font-bold text-slate-800 mb-4">Full Occupancy Data</h2>
                 <div class="overflow-x-auto">
                     <table class="w-full text-left text-sm whitespace-nowrap">
                         <thead class="text-slate-700 uppercase bg-slate-200">
                             <tr>
                                 <th rowspan="2" class="p-3">Location</th>
                                 <th colspan="3" class="p-3 text-center border-l border-b">Room Data</th>
                                 <th colspan="3" class="p-3 text-center border-l border-b">Headcount Data</th>
                             </tr>
                             <tr>
                                 <th class="p-3 text-center bg-slate-200 border-l">Capacity</th>
                                 <th class="p-3 text-center bg-slate-200">Occupied</th>
                                 <th class="p-3 text-center bg-slate-200">Available</th>
                                 <th class="p-3 text-center bg-slate-200 border-l">Capacity</th>
                                 <th class="p-3 text-center bg-slate-200">Occupied</th>
                                 <th class="p-3 text-center bg-slate-200">Available</th>
                             </tr>
                         </thead>
                         <tbody id="full-data-table" class="divide-y divide-slate-200">
                             </tbody>
                     </table>
                 </div>
                 <div class="mt-6 bg-cyan-50 border-l-4 border-cyan-500 p-6 rounded-r-lg">
                     <h3 class="text-xl font-bold text-slate-800">Strategic Recommendation</h3>
                     <p id="strategic-recommendation" class="text-slate-600 mt-2">Analyzing live data...</p>
                 </div>
            </section>
        </main>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        document.addEventListener('DOMContentLoaded', () => {
            const sheetId = '1hSz0M31duatu5WBhxVwdvwlGZpYt7nYM';
            const gid = '1151614936';
            const sheetUrl = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSgmzbrWw_B6bqf4otS0g3r-rguAH4g5MgYIMhkxrAhXatqjaT1S5o1xARMlbL9ng/pub?gid=1151614936&single=true&output=csv`;

            fetch(sheetUrl)
                .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok.'))
                .then(csvText => {
                    const housingData = parseSheetData(csvText);
                    if (housingData && housingData.length > 0) {
                        populateDashboard(housingData);
                    } else {
                        throw new Error("No data parsed from the sheet. Check sheet structure.");
                    }
                })
                .catch(error => {
                    console.error("Fetch Error:", error);
                    document.body.innerHTML = `<div class="p-10 text-center text-red-500"><strong>Error:</strong> Failed to load data from Google Sheet. <br><br> Please ensure you have followed the instructions to <strong>File > Share > Publish to web</strong> for the correct sheet, and that the data structure matches the expected format.</div>`;
                });
        });

        /**
         * Parses CSV data from the new sheet format.
         */
        function parseSheetData(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 7) return null; // Expect at least a header and 6 data rows

            // First line contains location headers, starting from the 3rd column
            const locations = lines[0].split(',').slice(2).map(s => s.trim().replace(/"/g, ''));
            
            const rawData = {};
            // Process data rows, skipping the header
            lines.slice(1).forEach(line => {
                const cols = line.split(',');
                const type = cols[0].trim().replace(/"/g, '');
                const status = cols[1].trim().replace(/"/g, '');
                if (type && status) {
                    const key = `${type}_${status}`; // e.g., "HEAD_Capacity"
                    // Get numerical values for the locations
                    rawData[key] = cols.slice(2).map(val => parseInt(val.trim(), 10) || 0);
                }
            });

            // Map the parsed raw data into the structured format the dashboard expects
            const housingData = locations.map((location, index) => {
                return {
                    location: location,
                    head_cap: rawData["HEAD_Capacity"] ? rawData["HEAD_Capacity"][index] : 0,
                    head_occ: rawData["HEAD_Occupied"] ? rawData["HEAD_Occupied"][index] : 0,
                    room_cap: rawData["ROOM_Capacity"] ? rawData["ROOM_Capacity"][index] : 0,
                    room_occ: rawData["ROOM_Occupied"] ? rawData["ROOM_Occupied"][index] : 0
                };
            });

            return housingData;
        }


        function populateDashboard(housingData) {
            populateKPIs(housingData);
            populateTable(housingData);
            createCharts(housingData);
        }

        function populateKPIs(housingData) {
            const kpiSection = document.getElementById('kpi-section');
            
            const totalRoomCap = housingData.reduce((sum, d) => sum + d.room_cap, 0);
            const totalRoomOcc = housingData.reduce((sum, d) => sum + d.room_occ, 0);
            const totalHeadCap = housingData.reduce((sum, d) => sum + d.head_cap, 0);
            const totalHeadOcc = housingData.reduce((sum, d) => sum + d.head_occ, 0);
            const totalRoomAvail = totalRoomCap - totalRoomOcc;
            const totalHeadAvail = totalHeadCap - totalHeadOcc;
            
            const roomOccPercentage = totalRoomCap > 0 ? ((totalRoomOcc / totalRoomCap) * 100).toFixed(0) : 0;
            const headFillPercentage = totalHeadCap > 0 ? ((totalHeadOcc / totalHeadCap) * 100).toFixed(0) : 0;
            
            const housing1 = housingData.find(d => d.location === 'HOUSING-1');
            const housing1AvailableRooms = housing1 ? housing1.room_cap - housing1.room_occ : 0;
            const availableRoomsInH1Percentage = totalRoomAvail > 0 ? ((housing1AvailableRooms / totalRoomAvail) * 100).toFixed(0) : 0;

            kpiSection.innerHTML = `
                <div class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200 text-center">
                    <h3 class="text-slate-500 font-semibold text-lg">Overall Room Occupancy</h3>
                    <p class="text-cyan-600 text-5xl font-bold mt-2">${roomOccPercentage}%</p>
                    <p class="text-slate-400">${totalRoomOcc} of ${totalRoomCap} Rooms</p>
                </div>
                <div class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200 text-center">
                    <h3 class="text-slate-500 font-semibold text-lg">Overall Headcount Fill</h3>
                    <p class="text-cyan-600 text-5xl font-bold mt-2">${headFillPercentage}%</p>
                    <p class="text-slate-400">${totalHeadOcc.toLocaleString('en-IN')} of ${totalHeadCap.toLocaleString('en-IN')} Capacity</p>
                </div>
                <div class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200 text-center">
                    <h3 class="text-slate-500 font-semibold text-lg">Total Available Rooms</h3>
                    <p class="text-cyan-600 text-5xl font-bold mt-2">${totalRoomAvail}</p>
                    <p class="text-slate-400">${availableRoomsInH1Percentage}% are in Housing-1</p>
                </div>
                 <div class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200 text-center">
                    <h3 class="text-slate-500 font-semibold text-lg">Available Headcount</h3>
                    <p class="text-cyan-600 text-5xl font-bold mt-2">${totalHeadAvail.toLocaleString('en-IN')}</p>
                    <p class="text-slate-400">Space for Future Growth</p>
                </div>`;
            
             document.getElementById('strategic-recommendation').textContent = `While room occupancy is high at ${roomOccPercentage}%, headcount capacity is only at ${headFillPercentage}%. This suggests our current facilities can support over ${totalHeadAvail.toLocaleString('en-IN')} more personnel.`;
        }
        
        function populateTable(housingData) {
            const tableBody = document.getElementById('full-data-table');
            tableBody.innerHTML = ''; // Clear previous data

            let totalRoomCap = 0, totalRoomOcc = 0, totalHeadCap = 0, totalHeadOcc = 0;
            
            housingData.forEach(d => {
                totalRoomCap += d.room_cap; totalRoomOcc += d.room_occ;
                totalHeadCap += d.head_cap; totalHeadOcc += d.head_occ;
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-100';
                row.innerHTML = `
                    <td class="p-3 font-medium text-slate-800">${d.location}</td>
                    <td class="p-3 text-center border-l">${d.room_cap}</td>
                    <td class="p-3 text-center">${d.room_occ}</td>
                    <td class="p-3 text-center">${d.room_cap - d.room_occ}</td>
                    <td class="p-3 text-center border-l">${d.head_cap.toLocaleString('en-IN')}</td>
                    <td class="p-3 text-center">${d.head_occ.toLocaleString('en-IN')}</td>
                    <td class="p-3 text-center">${(d.head_cap - d.head_occ).toLocaleString('en-IN')}</td>
                `;
                tableBody.appendChild(row);
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-slate-200 font-bold';
            totalRow.innerHTML = `
                <td class="p-3 text-slate-800">TOTAL</td>
                <td class="p-3 text-center border-l">${totalRoomCap}</td>
                <td class="p-3 text-center">${totalRoomOcc}</td>
                <td class="p-3 text-center">${totalRoomCap - totalRoomOcc}</td>
                <td class="p-3 text-center border-l">${totalHeadCap.toLocaleString('en-IN')}</td>
                <td class="p-3 text-center">${totalHeadOcc.toLocaleString('en-IN')}</td>
                <td class="p-3 text-center">${(totalHeadCap - totalHeadOcc).toLocaleString('en-IN')}</td>
            `;
            tableBody.appendChild(totalRow);
        }

        function createCharts(housingData) {
            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom' },
                    datalabels: { 
                        display: (c) => c.dataset.data[c.dataIndex] > 0, 
                        color: (c) => c.dataset.label === 'Occupied' ? '#fff' : '#334155',
                        font: { weight: 'bold' } 
                    }
                },
                scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, grid: { color: '#e2e8f0' } } }
            };

            new Chart(document.getElementById('roomChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: housingData.map(d => d.location),
                    datasets: [
                        { label: 'Occupied', data: housingData.map(d => d.room_occ), backgroundColor: '#06b6d4' },
                        { label: 'Available', data: housingData.map(d => d.room_cap - d.room_occ), backgroundColor: '#cbd5e1' }
                    ]
                },
                options: chartOptions
            });

            new Chart(document.getElementById('headcountChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: housingData.map(d => d.location),
                    datasets: [
                        { label: 'Occupied', data: housingData.map(d => d.head_occ), backgroundColor: '#0891b2' },
                        { label: 'Available', data: housingData.map(d => d.head_cap - d.head_occ), backgroundColor: '#cbd5e1' }
                    ]
                },
                options: chartOptions
            });
        }
    </script>
</body>
</html>
