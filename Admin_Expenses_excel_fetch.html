<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrative Expense Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .kpi-card {
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-7xl bg-white rounded-2xl shadow-2xl overflow-hidden">
        <header class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6">
            <h1 class="text-3xl font-extrabold tracking-tight">Administrative Expense Dashboard</h1>
            <p class="text-slate-300 text-lg mt-1">Performance Analysis: July - September 2025</p>
        </header>

        <main class="p-6 md:p-8">
            <section id="kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                 <div id="kpi-total-expense" class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200"></div>
                 <div id="kpi-highest-expense" class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200"></div>
                 <div id="kpi-top-drivers" class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200"></div>
                 <div id="kpi-largest-increase" class="kpi-card bg-slate-50 p-6 rounded-xl border border-slate-200"></div>
            </section>

            <section class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-8">
                <div class="lg:col-span-3 bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Top 5 Expense Comparison</h2>
                    <div class="relative h-[400px]"><canvas id="expenseChart"></canvas></div>
                </div>
                <div class="lg:col-span-2 bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Analysis & Recommendation</h2>
                    <ul id="analysis-list" class="space-y-4 text-slate-600 mb-6">
                        </ul>
                    <div class="bg-slate-200 border-l-4 border-slate-500 p-4 rounded-r-lg">
                        <h3 class="text-lg font-bold text-slate-800">Strategic Focus</h3>
                        <p class="text-slate-700 mt-2">To achieve meaningful cost savings, a strategic review of the high-value contracts for the top expense drivers is imperative. Optimizing these areas presents the most significant opportunity for budget reduction.</p>
                    </div>
                </div>
            </section>

            <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Full Expense Breakdown</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="text-slate-700 uppercase bg-slate-200 sticky top-0">
                            <tr>
                                <th class="p-3">Service Type</th>
                                <th class="p-3 text-right">July (₹)</th>
                                <th class="p-3 text-right">August (₹)</th>
                                <th class="p-3 text-right">September (₹)</th>
                                <th class="p-3 text-center">Trend (Aug-Sep)</th>
                            </tr>
                        </thead>
                        <tbody id="full-data-table" class="divide-y divide-slate-200">
                            </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // URL to your Google Sheet, published as a CSV
            const sheetId = '1hSz0M31duatu5WBhxVwdvwlGZpYt7nYM';
            const gid = '1036512239';
            const sheetUrl = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSgmzbrWw_B6bqf4otS0g3r-rguAH4g5MgYIMhkxrAhXatqjaT1S5o1xARMlbL9ng/pub?output=csv&gid=1036512239`;// https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}

            fetch(sheetUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(csvText => {
                    const expenseData = parseCSV(csvText);
                    populateDashboard(expenseData);
                })
                .catch(error => {
                    console.error('Error fetching or parsing sheet data:', error);
                    // Display an error message on the dashboard
                    document.body.innerHTML = `<div class="text-red-500 text-center p-10">Error loading data from Google Sheet. Please ensure the link is correct and the sheet is publicly accessible.</div>`;
                });
        });

        /**
         * Parses CSV text into an array of expense objects.
         */
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            // Skip the header row (index 0) and the empty line at the end
            const rows = lines.slice(1, -1); 

            return rows.map(row => {
                // This regex handles commas inside quoted fields
                const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                const cleanValue = (val) => {
                    if (!val || val.trim() === '-') return 0;
                    // Remove currency symbols, quotes, and commas then parse
                    return parseInt(val.replace(/[^0-9.-]+/g, ''), 10) || 0;
                };

                return {
                    service: values[1] ? values[1].replace(/"/g, '').trim() : 'N/A',
                    jul: cleanValue(values[2]),
                    aug: cleanValue(values[3]),
                    sep: cleanValue(values[4]),
                };
            }).filter(d => d.service !== 'Grand Total'); // Ensure Grand Total row is excluded
        }
        
        /**
         * Main function to populate the entire dashboard with data.
         */
        function populateDashboard(expenseData) {
            populateTable(expenseData);
            populateKPIs(expenseData);
            createTop5Chart(expenseData);
            populateAnalysis(expenseData);
        }

        /**
         * Populates the main data table.
         */
        function populateTable(expenseData) {
            const tableBody = document.getElementById('full-data-table');
            tableBody.innerHTML = ''; // Clear existing data
            
            let totalJul = 0, totalAug = 0, totalSep = 0;

            expenseData.forEach(d => {
                totalJul += d.jul;
                totalAug += d.aug;
                totalSep += d.sep;

                const trend = d.sep > d.aug ? '<span class="text-green-500">▲</span>' : d.sep < d.aug ? '<span class="text-red-500">▼</span>' : '<span class="text-slate-400">-</span>';
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-100';
                row.innerHTML = `
                    <td class="p-3 font-medium text-slate-800">${d.service}</td>
                    <td class="p-3 text-right">${d.jul > 0 ? `₹${d.jul.toLocaleString('en-IN')}` : '-'}</td>
                    <td class="p-3 text-right">${d.aug > 0 ? `₹${d.aug.toLocaleString('en-IN')}` : '-'}</td>
                    <td class="p-3 text-right">${d.sep > 0 ? `₹${d.sep.toLocaleString('en-IN')}` : '-'}</td>
                    <td class="p-3 text-center">${trend}</td>
                `;
                tableBody.appendChild(row);
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-slate-200 font-bold';
            totalRow.innerHTML = `
                <td class="p-3 text-slate-800">TOTAL</td>
                <td class="p-3 text-right">₹${totalJul.toLocaleString('en-IN')}</td>
                <td class="p-3 text-right">₹${totalAug.toLocaleString('en-IN')}</td>
                <td class="p-3 text-right">₹${totalSep.toLocaleString('en-IN')}</td>
                <td class="p-3 text-center">${totalSep > totalAug ? '<span class="text-green-500">▲</span>' : '<span class="text-red-500">▼</span>'}</td>
            `;
            tableBody.appendChild(totalRow);
        }

        /**
         * Calculates and populates the KPI cards.
         */
        function populateKPIs(expenseData) {
            const totalSep = expenseData.reduce((sum, d) => sum + d.sep, 0);
            const totalAug = expenseData.reduce((sum, d) => sum + d.aug, 0);
            
            // KPI 1: Total Expense
            const changeFromAug = totalAug > 0 ? ((totalSep - totalAug) / totalAug) * 100 : 0;
            const changeText = changeFromAug >= 0 ? `Up ${changeFromAug.toFixed(1)}%` : `Down ${Math.abs(changeFromAug).toFixed(1)}%`;
            const changeColor = changeFromAug >= 0 ? 'text-red-500' : 'text-green-500';
            document.getElementById('kpi-total-expense').innerHTML = `
                <h3 class="text-slate-500 font-semibold text-lg">Total Expense (Sep)</h3>
                <p class="text-slate-800 text-5xl font-bold mt-2">₹${(totalSep / 10000000).toFixed(2)}Cr</p>
                <p class="${changeColor} font-semibold flex items-center">${changeText} from August</p>`;

            // KPI 2: Highest Expense
            const highestSep = [...expenseData].sort((a,b) => b.sep - a.sep)[0];
             document.getElementById('kpi-highest-expense').innerHTML = `
                <h3 class="text-slate-500 font-semibold text-lg">Highest Expense (Sep)</h3>
                <p class="text-slate-800 text-4xl font-bold mt-2 truncate">${highestSep.service}</p>
                <p class="text-slate-400">₹${(highestSep.sep / 100000).toFixed(2)} Lakhs</p>`;

            // KPI 3: Top 2 Drivers
            const top2Sep = [...expenseData].sort((a,b) => b.sep - a.sep).slice(0,2);
            const top2Total = top2Sep.reduce((sum,d) => sum + d.sep, 0);
            const top2Percent = (top2Total / totalSep * 100).toFixed(1);
            document.getElementById('kpi-top-drivers').innerHTML = `
                 <h3 class="text-slate-500 font-semibold text-lg">Top 2 Drivers</h3>
                 <p class="text-slate-800 text-5xl font-bold mt-2">${top2Percent}%</p>
                 <p class="text-slate-400 truncate">${top2Sep[0].service} & ${top2Sep[1].service}</p>`;
            
            // KPI 4: Largest Increase from July
             expenseData.forEach(d => d.increase = d.sep - d.jul);
             const largestIncrease = [...expenseData].sort((a, b) => b.increase - a.increase)[0];
             const increasePercent = largestIncrease.jul > 0 ? (largestIncrease.increase / largestIncrease.jul * 100) : 100;
             document.getElementById('kpi-largest-increase').innerHTML = `
                 <h3 class="text-slate-500 font-semibold text-lg">Largest Increase (Jul-Sep)</h3>
                 <p class="text-slate-800 text-4xl font-bold mt-2 truncate">${largestIncrease.service}</p>
                 <p class="text-red-500 font-semibold">Up ${increasePercent.toFixed(1)}% from July</p>`;
        }
        
        /**
         * Populates the Analysis & Recommendation section.
         */
        function populateAnalysis(expenseData) {
            const list = document.getElementById('analysis-list');
            const top2Sep = [...expenseData].sort((a,b) => b.sep - a.sep).slice(0,2);
            expenseData.forEach(d => d.increase = d.sep - d.aug);
            const biggestSpike = [...expenseData].sort((a,b)=> b.increase - a.increase)[0];
            const spikePercent = biggestSpike.aug > 0 ? (biggestSpike.increase / biggestSpike.aug * 100) : 100;

            list.innerHTML = `
                <li class="flex items-start">
                    <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div><strong>Top Cost Drivers:</strong> '${top2Sep[0].service}' & '${top2Sep[1].service}' consistently dominate spending, requiring strategic review.</div>
                </li>
                <li class="flex items-start">
                    <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    <div><strong>Significant Spike:</strong> '${biggestSpike.service}' saw a major ${spikePercent.toFixed(1)}% increase in September, needing further investigation.</div>
                </li>
            `;
        }

        /**
         * Creates the Top 5 expense comparison bar chart.
         */
        function createTop5Chart(expenseData) {
            const sortedBySep = [...expenseData].sort((a, b) => b.sep - a.sep);
            const top5Data = sortedBySep.slice(0, 5);
            
            const chartCtx = document.getElementById('expenseChart').getContext('2d');
            new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: top5Data.map(d => d.service),
                    datasets: [
                        { label: 'Jul-25', data: top5Data.map(d => d.jul), backgroundColor: 'rgba(100, 116, 139, 0.6)' },
                        { label: 'Aug-25', data: top5Data.map(d => d.aug), backgroundColor: 'rgba(59, 130, 246, 0.6)' },
                        { label: 'Sep-25', data: top5Data.map(d => d.sep), backgroundColor: 'rgba(29, 78, 216, 0.8)' },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ₹${c.parsed.y.toLocaleString('en-IN')}` } },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (v) => v >= 100000 ? `₹${(v / 100000).toFixed(0)}L` : `₹${v / 1000}K` }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
